<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Film Details</title>
    <link rel="stylesheet" th:href="@{/css/book.css}">
    <style>
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.hidden {
            display: none;
        }

        .notification.success {
            background-color: #4CAF50;
            color: white;
        }

        .notification.error {
            background-color: #f44336;
            color: white;
        }

        .notification-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification-message {
            font-weight: bold;
        }

        .notification-details {
            font-size: 0.9em;
        }

        .notification p {
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-content">
            <a th:href="@{/}" class="nav-brand">Rent Film</a>
            <div class="nav-links">
                <a th:href="@{/home}" class="nav-link">Home</a>
                <a th:href="@{/explore}" class="nav-link active">Explore</a>
                <div class="user-profile">
                    <span th:text="${username}">username</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <!-- Notification Popup -->
    <div id="notification" class="notification hidden">
        <div class="notification-content">
            <span class="notification-message"></span>
            <div class="notification-details">
                <p>Durasi Sewa: <span id="rentalDuration"></span> hari</p>
                <p>Tanggal Kembali: <span id="returnDate"></span></p>
            </div>
        </div>
    </div>

        <div class="detail-card">
            <div class="detail-content">
                <!-- Film Cover -->
                <div class="film-cover-container">
                    <img th:src="@{${film.coverUrl != null ? '/covers/' + film.coverUrl : '/images/default-cover.jpg'}}"
                         th:alt="${film.judul}" class="film-cover">
                </div>

                <!-- Film Info -->
                <div class="film-info">
                    <h1 class="film-title" th:text="${film.judul}">Film Title</h1>

                    <div th:if="${film.stok > 0}" class="stock-badge">
                        <span th:text="|Stock: ${film.stok}|">Stock: 5</span>
                    </div>
                    <div th:if="${film.stok <= 0}" class="stock-badge out-of-stock">
                        Out of Stock
                    </div>

                    <div class="info-grid">
                        <div class="info-item">
                            <h3>Genre</h3>
                            <p th:text="${film.genreNama}">Action, Adventure</p>
                        </div>
                        <div class="info-item">
                            <h3>Release Year</h3>
                            <p th:text="${film.tahunRilis}">2023</p>
                        </div>
                        <div class="info-item">
                            <h3>Rating</h3>
                            <p th:text="${film.averageRating != null ? film.averageRating + '/5.0' : 'Not rated yet'}">
                                Not rated yet</p>
                        </div>
                        <div class="info-item">
                            <h3>Total Reviews</h3>
                            <p th:text="${film.totalReviews ?: '0'}">0</p>
                        </div>
                    </div>

                    <div class="synopsis">
                        <h3>Synopsis</h3>
                        <p th:text="${film.deskripsi}">Film description goes here.</p>
                    </div>

                    <div class="cast" th:if="${film.aktorNames != null and not #lists.isEmpty(film.aktorNames)}">
                        <h3>Cast</h3>
                        <p th:text="${#strings.listJoin(film.aktorNames, ', ')}">Actor 1, Actor 2, Actor 3</p>
                    </div>

                    <!-- Booking form -->
                    <form th:if="${film.stok > 0}" 
                          th:action="@{/films/{id}/book/confirm(id=${film.id})}" 
                          method="post" 
                          id="bookingForm" 
                          class="booking-form">
                        
                        <div class="form-group">
                            <label for="duration" class="form-label">Rental Duration (days)</label>
                            <select name="duration" id="duration" class="form-select">
                                <option value="3">3 days</option>
                                <option value="5">5 days</option>
                                <option value="7">7 days</option>
                            </select>
                        </div>
                        <button type="submit" class="book-button">
                            Book Now
                        </button>
                    </form>

                    <button th:if="${film.stok <= 0}" class="book-button disabled" disabled>
                        Out of Stock
                    </button>

                    <!-- Additional Rental Information -->
                    <div class="rental-info" th:if="${film.totalRentals != null or film.rentedCount != null}">
                        <h3>Rental Statistics</h3>
                        <p th:if="${film.totalRentals != null}" th:text="|Total times rented: ${film.totalRentals}|">
                            Total times rented: 0</p>
                        <p th:if="${film.rentedCount != null}" th:text="|Currently rented: ${film.rentedCount}|">
                            Currently rented: 0</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
<<<<<<< HEAD
</body>
<script>
    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const form = e.target;
        const duration = form.querySelector('select[name="duration"]').value;

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `duration=${duration}`
            });

=======

    <script>
        function showNotification(type, message, duration) {
>>>>>>> ea3720d37365f52c84ef374a9ea717d72e9266af
            const notification = document.getElementById('notification');
            const messageElement = notification.querySelector('.notification-message');
            const rentalDurationElement = document.getElementById('rentalDuration');
            const returnDateElement = document.getElementById('returnDate');

<<<<<<< HEAD
=======
            // Debug log
            console.log('Showing notification:', { type, message, duration });

            // Remove existing classes and add new ones
>>>>>>> ea3720d37365f52c84ef374a9ea717d72e9266af
            notification.classList.remove('success', 'error', 'hidden');
            notification.classList.add(type);
            messageElement.textContent = message;

<<<<<<< HEAD
            const redirectUrl = response.url;
            const urlParams = new URLSearchParams(new URL(redirectUrl).search);

            if (urlParams.has('success')) {
                messageElement.textContent = 'Film berhasil dibooking!';
                notification.classList.add('success');

                // Update stock display
                const stockElement = document.querySelector('.stock-badge span');
                if (stockElement) {
                    const currentStock = parseInt(stockElement.textContent.split(': ')[1]);
                    stockElement.textContent = `Stock: ${currentStock - 1}`;
                }

                // Update rental duration and return date
                if (rentalDurationElement && returnDateElement) {
                    rentalDurationElement.textContent = duration;
                    const returnDate = new Date();
                    returnDate.setDate(returnDate.getDate() + parseInt(duration));
                    returnDateElement.textContent = returnDate.toISOString().split('T')[0];
                }

                // Redirect to rentals page after success
                setTimeout(() => {
                    window.location.href = '/explore';
                }, 2000);
            } else {
                let errorMessage = 'Gagal membooking film. Silakan coba lagi.';
                if (urlParams.has('error')) {
                    const errorType = urlParams.get('error');
                    switch (errorType) {
                        case 'outofstock':
                            errorMessage = 'Maaf, film sedang tidak tersedia.';
                            break;
                        case 'alreadybooked':
                            errorMessage = 'Anda sudah membooking film ini.';
                            break;
                    }
                }
                messageElement.textContent = errorMessage;
                notification.classList.add('error');
=======
            if (type === 'success' && duration) {
                rentalDurationElement.textContent = duration;
                const returnDate = new Date();
                returnDate.setDate(returnDate.getDate() + parseInt(duration));
                returnDateElement.textContent = returnDate.toLocaleDateString();
>>>>>>> ea3720d37365f52c84ef374a9ea717d72e9266af
            }

            notification.classList.add('show');

<<<<<<< HEAD
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 300);
            }, 5000);

        } catch (error) {
            console.error('Error:', error);
            const notification = document.getElementById('notification');
            const messageElement = notification.querySelector('.notification-message');

            notification.classList.remove('success', 'error', 'hidden');
            notification.classList.add('error');
            messageElement.textContent = 'Gagal membooking film. Silakan coba lagi.';

            notification.classList.add('show');
=======
            // Hide after 5 seconds
>>>>>>> ea3720d37365f52c84ef374a9ea717d72e9266af
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 300);
            }, 5000);
        }

        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const duration = formData.get('duration');
            
            // Debug logs
            console.log('Form action URL:', this.action);
            console.log('Duration:', duration);

            // Create URLSearchParams
            const params = new URLSearchParams();
            params.append('duration', duration);
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params.toString(),
                credentials: 'same-origin'
            })
            .then(response => {
                // Debug log
                console.log('Response status:', response.status);
                console.log('Response URL:', response.url);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            })
            .then(response => {
                const responseUrl = new URL(response.url);
                console.log('Response URL params:', Object.fromEntries(responseUrl.searchParams));

                if (responseUrl.searchParams.has('error')) {
                    const errorType = responseUrl.searchParams.get('error');
                    const errorMessage = {
                        'outofstock': 'Sorry, this film is out of stock.',
                        'alreadybooked': 'You have already booked this film.'
                    }[errorType] || 'Failed to book the film. Please try again.';
                    
                    showNotification('error', errorMessage);
                } else {
                    showNotification('success', 'Film successfully booked!', duration);
                    
                    // Update stock display
                    const stockElement = document.querySelector('.stock-badge span');
                    if (stockElement) {
                        const currentStock = parseInt(stockElement.textContent.split(': ')[1]) - 1;
                        stockElement.textContent = `Stock: ${currentStock}`;
                    }
                    
                    // Redirect after delay
                    setTimeout(() => {
                        window.location.href = '/history';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error details:', error);
                showNotification('error', 'Failed to book the film. Please try again.');
            });
        });
    </script>
</body>
</html>